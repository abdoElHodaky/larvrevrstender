version: '3.8'

# Staging Environment Overrides for Reverse Tender Platform
# This file contains staging-specific configurations with reduced resources

services:
  # API Gateway - Staging resource limits
  api-gateway:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Auth Service - Staging resource limits
  auth-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Bidding Service - Reduced resources for staging
  bidding-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # User Service - Staging resource limits
  user-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Order Service - Staging resource limits
  order-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Notification Service - Staging resource limits
  notification-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Payment Service - Staging resource limits
  payment-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Analytics Service - Staging resource limits
  analytics-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # VIN OCR Service - Reduced resources for staging
  vin-ocr-service:
    environment:
      - APP_DEBUG=true
      - LOG_LEVEL=debug
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # MySQL Primary - Staging database resources
  mysql-primary:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  # Redis Primary - Staging cache resources
  redis-primary:
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # Nginx - Staging proxy resources
  nginx:
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

  # Staging Monitoring - Prometheus (optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: rt_prometheus_staging
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_staging_data:/prometheus
    networks:
      - reverse-tender-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    profiles:
      - monitoring

  # Staging Monitoring - Grafana (optional)
  grafana:
    image: grafana/grafana:latest
    container_name: rt_grafana_staging
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
    volumes:
      - grafana_staging_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - reverse-tender-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    profiles:
      - monitoring

volumes:
  prometheus_staging_data:
    driver: local
  grafana_staging_data:
    driver: local

